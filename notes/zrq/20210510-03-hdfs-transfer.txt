#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2020, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#


    Target:

        Create a new Manila share for the repartitioned data and neighbour tables

    Result:

        Work in progress ....


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"
    AGLAIS_CLOUD=gaia-dev

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --env "cloudname=${AGLAIS_CLOUD:?}" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/deployments:/deployments:ro,z" \
        atolmis/ansible-client:2020.12.02 \
        bash


# -----------------------------------------------------
# Set the Manila API version.
# https://stackoverflow.com/a/58806536
#[user@kubernator]

    export OS_SHARE_API_VERSION=2.51


# -----------------------------------------------------
# Create a new share for the Gaia data.
#[root@ansibler]

    sharename=aglais-gaia-edr3-20210510
    sharesize=1024
    sharecloud=gaia-prod

    openstack \
        --os-cloud "${sharecloud:?}" \
        share create \
            --format json \
            --name "${sharename:?}" \
            --share-type 'cephfsnativetype' \
            --availability-zone 'nova' \
            'CEPHFS' \
            "${sharesize:?}" \
    | tee /tmp/manila-share.json

    shareid=$(
        jq -r '.id' /tmp/manila-share.json
        )

    openstack \
        --os-cloud "${sharecloud:?}" \
            share show \
                "${shareid:?}"

--START--
+---------------------------------------+----------------------------------------+
| Field                                 | Value                                  |
+---------------------------------------+----------------------------------------+
| access_rules_status                   | active                                 |
| availability_zone                     | nova                                   |
| created_at                            | 2021-05-11T01:23:04.000000             |
| description                           | None                                   |
| ....                                  | ....                                   |
| id                                    | d583565e-de86-46df-9969-f587e4d61a37   |
| is_public                             | False                                  |
| ....                                  | ....                                   |
| volume_type                           | cephfsnativetype                       |
+---------------------------------------+----------------------------------------+
--END--


    openstack \
        --os-cloud "${sharecloud:?}" \
            share set \
                "${shareid:?}" \
                --public true


    openstack \
        --os-cloud "${sharecloud:?}" \
            share show \
                "${shareid:?}"

--START--
+---------------------------------------+----------------------------------------+
| Field                                 | Value                                  |
+---------------------------------------+----------------------------------------+
| ....                                  | ....                                   |
| id                                    | d583565e-de86-46df-9969-f587e4d61a37   |
| is_public                             | True                                   |
| ....                                  | ....                                   |
+---------------------------------------+----------------------------------------+
--END--


# -----------------------------------------------------
# Get details of the Ceph export location.
#[root@ansibler]

    openstack \
        --os-cloud "${sharecloud:?}" \
        share show \
            --format json \
            "${shareid:?}" \
    | jq '.' \
    | tee /tmp/manila-share.json

    locations=$(
        jq '.export_locations' /tmp/manila-share.json
        )

    cephnodes=$(
        echo "${locations:?}" |
        sed '
            s/^.*path = \([^\\]*\).*$/\1/
            s/^\(.*\):\(\/.*\)$/\1/
            s/,/ /g
            '
            )

    cephpath=$(
        echo "${locations:?}" |
        sed '
            s/^.*path = \([^\\]*\).*$/\1/
            s/^\(.*\):\(\/.*\)$/\2/
            '
            )

    cephsize=$(
        jq '.size' /tmp/manila-share.json
        )

    cat << EOF
Ceph path [${cephpath}]
Ceph size [${cephsize}]
EOF

    for cephnode in ${cephnodes}
    do
        echo "Ceph node [${cephnode}]"
    done

--START--
Ceph path [/volumes/_nogroup/622bb766-6ae2-4aa5-ad9c-536a71012245]
Ceph size [1024]

Ceph node [10.206.1.5:6789]
Ceph node [10.206.1.6:6789]
Ceph node [10.206.1.7:6789]
--END--


# -----------------------------------------------------
# Add a read-only access rule.
#[root@ansibler]

    openstack \
        --os-cloud "${sharecloud:?}" \
        share access create \
            --format json \
            --access-level 'ro' \
            "${shareid:?}" \
            'cephx' \
            "${sharename:?}-ro"

--START--
{
  "id": "f6ad0bc0-29ec-4686-a35c-a766c1a259e0",
  "share_id": "d583565e-de86-46df-9969-f587e4d61a37",
  "access_level": "ro",
  "access_to": "aglais-gaia-edr3-20210510-ro",
  "access_type": "cephx",
  "state": "queued_to_apply",
  "access_key": null,
  "created_at": "2021-05-11T01:33:06.000000",
  "updated_at": null,
  "properties": ""
}
--END--


# -----------------------------------------------------
# Add a read-write access rule.
#[root@ansibler]

    openstack \
        --os-cloud "${sharecloud:?}" \
        share access create \
            --format json \
            --access-level 'rw' \
            "${shareid:?}" \
            'cephx' \
            "${sharename:?}-rw"

--START--
{
  "id": "88a1894c-074d-4b9b-a264-76130773116c",
  "share_id": "d583565e-de86-46df-9969-f587e4d61a37",
  "access_level": "rw",
  "access_to": "aglais-gaia-edr3-20210510-rw",
  "access_type": "cephx",
  "state": "queued_to_apply",
  "access_key": null,
  "created_at": "2021-05-11T01:33:33.000000",
  "updated_at": null,
  "properties": ""
}
--END--


# -----------------------------------------------------
# Create our Ansible vars file.
#[root@ansibler]

    cat > '/tmp/aglais-status.yml' << EOF
aglais:
  status:
    deployment:
      type: hadoop-yarn
      conf: tiny-16
      name: gaia-dev-20210505
  spec:
    openstack:
      cloud: ${cloudname}
EOF

    ln -sf '/tmp/aglais-status.yml' '/tmp/ansible-vars.yml'


    #
    # EEK
    # Share mount commands from old notes use 'hosts.yml' but the deployment is based on 'tiny-16.yml'
    # The number and names of the hosts will have changed
    # Need to merge the changes from previous branch before we can do this ...
    #
    # OK - fixed
    # Moved to a new branch and fetched the latest changes from upstream
    #

# -----------------------------------------------------
# Change to the ansible directory.
#[root@ansibler]

    cd '/deployments/hadoop-yarn/ansible/'

# -----------------------------------------------------
# Create our client ssh config.
#[root@ansibler]

    deployconf=$(
        yq read /tmp/aglais-status.yml 'aglais.status.deployment.conf'
        )

    inventory="config/${deployconf}.yml"

    ansible-playbook \
        --inventory "${inventory:?}" \
        '05-config-ssh.yml'

    ansible-playbook \
        --inventory "${inventory:?}" \
        '08-ping-test.yml'


--START--
PLAY [Ping tests] ************************************************************************************************

TASK [Check we can connect] **************************************************************************************
ok: [zeppelin]
ok: [master01]
....
....
ok: [worker15]
ok: [worker16]

TASK [Check we can use sudo] *************************************************************************************
ok: [zeppelin]
ok: [master01]
....
....
ok: [worker15]
ok: [worker16]

PLAY RECAP *******************************************************************************************************
zeppelin                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
master01                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
....
....
worker15                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
worker16                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
--END--


# -----------------------------------------------------
# Mount the share into all our nodes.
#[root@ansibler]

    mountpath=/data/gaia/edr3-20210510
    mountmode=rw

    "/deployments/hadoop-yarn/bin/cephfs-mount.sh" \
        "${sharecloud:?}" \
        "${inventory:?}" \
        "${sharename:?}" \
        "${mountpath:?}" \
        "${mountmode:?}"

--START--
---- ---- ----
File [cephfs-mount.sh]
Path [/deployments/hadoop-yarn/bin]
Tree [/deployments]
---- ---- ----
Cloud name [gaia-prod]
Hosts file [config/tiny-16.yml]
Share name [aglais-gaia-edr3-20210510]
Mount path [/data/gaia/edr3-20210510]
Share mode [rw]
---- ---- ----

Target [gaia-prod][aglais-gaia-edr3-20210510]
Found  [d583565e-de86-46df-9969-f587e4d61a37]
----
Ceph path [/volumes/_nogroup/622bb766-6ae2-4aa5-ad9c-536a71012245]
Ceph size [1024]
----
Ceph node [10.206.1.5:6789]
Ceph node [10.206.1.6:6789]
Ceph node [10.206.1.7:6789]
----
Ceph user [aglais-gaia-edr3-20210510-rw]
Ceph key  [####-####]

PLAY [Install and mount a CephFS share] **************************************************************************

TASK [Install CephFS Fuse client] ********************************************************************************
changed: [zeppelin]
changed: [master01]
....
changed: [worker15]
changed: [worker16]

TASK [Creating CephFS key file [/etc/ceph/aglais-gaia-edr3-20210510-rw.keyring]] *********************************
changed: [zeppelin]
changed: [master01]
....
changed: [worker15]
changed: [worker16]

TASK [Creating CephFS cfg file [/etc/ceph/aglais-gaia-edr3-20210510-rw.conf]] ************************************
changed: [zeppelin]
changed: [master01]
....
changed: [worker15]
changed: [worker16]

TASK [Creating CephFS fstab entry [/data/gaia/edr3-20210510]] ****************************************************
changed: [zeppelin]
changed: [master01]
....
changed: [worker15]
changed: [worker16]

PLAY RECAP *******************************************************************************************************
zeppelin                   : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
master01                   : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
....
worker15                   : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
worker16                   : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
--END--


# -----------------------------------------------------
# Login to a worker node to check the mount.
#[root@ansibler]

    ssh worker01 \
        "
        date
        hostname
        echo '----'
        df -h  '${mountpath:?}'
        "

--START--
Tue May 11 02:07:59 UTC 2021
gaia-dev-20210505-worker01.novalocal
----
Filesystem      Size  Used Avail Use% Mounted on
ceph-fuse       1.0T     0  1.0T   0% /data/gaia/edr3-20210510
--END--


# -----------------------------------------------------
# Login to a worker node to transfer the data.
#[root@ansibler]

    ssh worker01 \
        "
        sudo chmod a+rwx '${mountpath:?}'
        ls -al '${mountpath:?}'
        "

    ssh worker01 \
        "
        rsync \
            --verbose \
            --recursive \
            '/user/zrq/repartitioned/' \
            '${mountpath:?}'
        "

--START--
sending incremental file list
GEDR3/
GEDR3/_SUCCESS
GEDR3/part-00000-061dbeeb-75b5-41c3-9d01-422766759ddd_00000.c000.snappy.parquet
GEDR3/part-00001-061dbeeb-75b5-41c3-9d01-422766759ddd_00001.c000.snappy.parquet
GEDR3/part-00002-061dbeeb-75b5-41c3-9d01-422766759ddd_00002.c000.snappy.parquet
GEDR3/part-00003-061dbeeb-75b5-41c3-9d01-422766759ddd_00003.c000.snappy.parquet
GEDR3/part-00004-061dbeeb-75b5-41c3-9d01-422766759ddd_00004.c000.snappy.parquet
GEDR3/part-00005-061dbeeb-75b5-41c3-9d01-422766759ddd_00005.c000.snappy.parquet
....
....
--END--

    #
    # OMG this is slow ...
    #


# -----------------------------------------------------
# Login to a worker node to check the results.
#[root@ansibler]

    ssh worker01 \
        "
        date
        hostname
        echo '----'
        df -h  '${mountpath:?}'
        "

