#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2021, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#zrq-notes-zeppelin
#

    Target:

        Update our Spark fork

    Result:

        Complete

        TODO Do we need to update the version in our pom.xml files?


# -----------------------------------------------------
# Update the WFAU fork of Spark.
#[user@desktop]

    source "${HOME}/aglais.env"
    pushd  "${SPARK_HOME:?}"

        git clone git@github.com:WFAU/aglais-spark.git github-wfau

    >   Cloning into 'github-wfau'...
    >   remote: Enumerating objects: 48, done.
    >   remote: Counting objects: 100% (48/48), done.
    >   remote: Compressing objects: 100% (34/34), done.
    >   remote: Total 768836 (delta 25), reused 14 (delta 14), pack-reused 768788
    >   Receiving objects: 100% (768836/768836), 342.51 MiB | 1.55 MiB/s, done.
    >   Resolving deltas: 100% (322216/322216), done.
    >   Updating files: 100% (17158/17158), done.


        pushd github-wfau

            git remote -v

    >   origin	git@github.com:WFAU/aglais-spark.git (fetch)
    >   origin	git@github.com:WFAU/aglais-spark.git (push)

            git remote add upstream git@github.com:apache/spark.git

            git remote -v

    >   origin	git@github.com:WFAU/aglais-spark.git (fetch)
    >   origin	git@github.com:WFAU/aglais-spark.git (push)
    >   upstream	git@github.com:apache/spark.git (fetch)
    >   upstream	git@github.com:apache/spark.git (push)


            git fetch upstream

    >   remote: Enumerating objects: 2342, done.
    >   remote: Counting objects: 100% (2342/2342), done.
    >   remote: Compressing objects: 100% (23/23), done.
    >   remote: Total 5531 (delta 2317), reused 2326 (delta 2316), pack-reused 3189
    >   Receiving objects: 100% (5531/5531), 1.36 MiB | 1.70 MiB/s, done.
    >   Resolving deltas: 100% (2867/2867), completed with 907 local objects.
    >   From github.com:apache/spark
    >    * [new branch]            branch-0.5      -> upstream/branch-0.5
    >    * [new branch]            branch-0.6      -> upstream/branch-0.6
    >   ....
    >   ....
    >    * [new branch]            master          -> upstream/master
    >    * [new tag]               v3.1.0-rc1      -> v3.1.0-rc1


            git merge upstream/master
    >   Updating 1ef7ddd38a..1288ad814e
    >   Fast-forward
    >    .github/workflows/build_and_test.yml                   |   32 +-
    >    .github/workflows/cancel_duplicate_workflow_runs.yml   |   19 +
    >    R/pkg/DESCRIPTION                                      |    2 +-
    >    R/pkg/R/DataFrame.R                                    |    2 +-
    >   ....
    >   ....
    >    create mode 100644 sql/core/src/test/scala/org/apache/spark/sql/execution/command/v2/ShowNamespacesSuite.scala
    >    create mode 100644 sql/hive/src/test/scala/org/apache/spark/sql/hive/execution/command/ShowNamespacesSuite.scala


            git push

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   remote: This repository moved. Please use the new location:
    >   remote:   git@github.com:wfau/aglais-spark.git
    >   remote: error: GH006: Protected branch update failed for refs/heads/master.
    >   remote: error: At least 1 approving review is required by reviewers with write access.
    >   To github.com:WFAU/aglais-spark.git
    >    ! [remote rejected]       master -> master (protected branch hook declined)
    >   error: failed to push some refs to 'git@github.com:WFAU/aglais-spark.git'

            #
            # Update the GitHub branch rules to allow forced push.
            #

            git push --force

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   remote: This repository moved. Please use the new location:
    >   remote:   git@github.com:wfau/aglais-spark.git
    >   remote: error: GH006: Protected branch update failed for refs/heads/master.
    >   remote: error: At least 1 approving review is required by reviewers with write access.
    >   To github.com:WFAU/aglais-spark.git
    >    ! [remote rejected]       master -> master (protected branch hook declined)
    >   error: failed to push some refs to 'git@github.com:WFAU/aglais-spark.git'


            #
            # Remove the GitHub branch rule.
            #

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   remote: This repository moved. Please use the new location:
    >   remote:   git@github.com:wfau/aglais-spark.git
    >   To github.com:WFAU/aglais-spark.git
    >      1ef7ddd38a..1288ad814e  master -> master

            #
            # Restore the GitHub branch rule.
            #

        popd
    popd


# -----------------------------------------------------
# Update our personal fork of Spark.
#[user@desktop]

    source "${HOME}/aglais.env"
    pushd  "${SPARK_CODE:?}"

        git checkout master

    >   Already on 'master'
    >   Your branch is up to date with 'origin/master'.


        git remote -v

    >   origin	git@github.com:Zarquan/aglais-spark.git (fetch)
    >   origin	git@github.com:Zarquan/aglais-spark.git (push)

        git remote add upstream git@github.com:WFAU/aglais-spark.git

        git remote -v

    >   origin	git@github.com:Zarquan/aglais-spark.git (fetch)
    >   origin	git@github.com:Zarquan/aglais-spark.git (push)
    >   upstream	git@github.com:WFAU/aglais-spark.git (fetch)
    >   upstream	git@github.com:WFAU/aglais-spark.git (push)


        git fetch upstream

    >   remote: Enumerating objects: 1586, done.
    >   remote: Counting objects: 100% (1586/1586), done.
    >   remote: Compressing objects: 100% (17/17), done.
    >   remote: Total 3532 (delta 1569), reused 1572 (delta 1569), pack-reused 1946
    >   Receiving objects: 100% (3532/3532), 1.05 MiB | 410.00 KiB/s, done.
    >   Resolving deltas: 100% (1914/1914), completed with 621 local objects.
    >   From github.com:WFAU/aglais-spark
    >    * [new branch]            branch-0.5      -> upstream/branch-0.5
    >    * [new branch]            branch-0.6      -> upstream/branch-0.6
    >   ....
    >   ....
    >    * [new branch]            branch-3.1      -> upstream/branch-3.1
    >    * [new branch]            master          -> upstream/master


        git merge upstream/master

    >   Updating 1ef7ddd38a..1288ad814e
    >   Fast-forward
    >    .github/workflows/build_and_test.yml                   |   32 +-
    >    .github/workflows/cancel_duplicate_workflow_runs.yml   |   19 +
    >    R/pkg/DESCRIPTION                                      |    2 +-
    >    R/pkg/R/DataFrame.R                                    |    2 +-
    >   ....
    >   ....
    >    create mode 100644 sql/core/src/test/scala/org/apache/spark/sql/execution/command/v2/ShowNamespacesSuite.scala
    >    create mode 100644 sql/hive/src/test/scala/org/apache/spark/sql/hive/execution/command/ShowNamespacesSuite.scala


        git push

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   To github.com:Zarquan/aglais-spark.git
    >      1ef7ddd38a..1288ad814e  master -> master

    popd


# -----------------------------------------------------
# Branch our personal fork of Spark.
#[user@desktop]

    newbranch=$(date '+%Y%m%d')-zrq-working

    source "${HOME}/aglais.env"
    pushd  "${SPARK_CODE}"

        git checkout master

    >   Switched to branch 'master'
    >   Your branch is up to date with 'origin/master'.


        git checkout -b "${newbranch:?}"

    >   Switched to a new branch '20210114-zrq-working'


        git push --set-upstream origin "${newbranch:?}"

    >   Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
    >   remote:
    >   remote: Create a pull request for '20210114-zrq-working' on GitHub by visiting:
    >   remote:      https://github.com/Zarquan/aglais-spark/pull/new/20210114-zrq-working
    >   remote:
    >   To github.com:Zarquan/aglais-spark.git
    >    * [new branch]            20210114-zrq-working -> 20210114-zrq-working
    >   Branch '20210114-zrq-working' set up to track remote branch '20210114-zrq-working' from 'origin'.

    popd


# -----------------------------------------------------
# Update the POM version of our local fork.
#[user@desktop]

    source "${HOME}/aglais.env"
    pushd  "${SPARK_CODE:?}"

        oldversion=3.2.0-SNAPSHOT
        newversion=aglais-20210114

        for pom in $(find . -name 'pom.xml')
        do
            sed -i "
                s/<version>${oldversion:?}<\/version>/<version project='aglais-spark'>${newversion:?}<\/version>/
                " "${pom:?}"
        done

        git add .
        git status

    >   On branch 20210114-zrq-working
    >   Your branch is up to date with 'origin/20210114-zrq-working'.
    >   
    >   Changes to be committed:
    >     (use "git restore --staged <file>..." to unstage)
    >   	modified:   assembly/pom.xml
    >   	modified:   common/kvstore/pom.xml
    >   	modified:   common/network-common/pom.xml
    >   	modified:   common/network-shuffle/pom.xml
    >   	modified:   common/network-yarn/pom.xml
    >   	modified:   common/sketch/pom.xml
    >   	modified:   common/tags/pom.xml
    >   	modified:   common/unsafe/pom.xml
    >   	modified:   core/pom.xml
    >   	modified:   examples/pom.xml
    >   	modified:   external/avro/pom.xml
    >   	modified:   external/docker-integration-tests/pom.xml
    >   	modified:   external/kafka-0-10-assembly/pom.xml
    >   	modified:   external/kafka-0-10-sql/pom.xml
    >   	modified:   external/kafka-0-10-token-provider/pom.xml
    >   	modified:   external/kafka-0-10/pom.xml
    >   	modified:   external/kinesis-asl-assembly/pom.xml
    >   	modified:   external/kinesis-asl/pom.xml
    >   	modified:   external/spark-ganglia-lgpl/pom.xml
    >   	modified:   graphx/pom.xml
    >   	modified:   hadoop-cloud/pom.xml
    >   	modified:   launcher/pom.xml
    >   	modified:   mllib-local/pom.xml
    >   	modified:   mllib/pom.xml
    >   	modified:   pom.xml
    >   	modified:   repl/pom.xml
    >   	modified:   resource-managers/kubernetes/core/pom.xml
    >   	modified:   resource-managers/kubernetes/integration-tests/pom.xml
    >   	modified:   resource-managers/mesos/pom.xml
    >   	modified:   resource-managers/yarn/pom.xml
    >   	modified:   sql/catalyst/pom.xml
    >   	modified:   sql/core/pom.xml
    >   	modified:   sql/hive-thriftserver/pom.xml
    >   	modified:   sql/hive/pom.xml
    >   	modified:   streaming/pom.xml
    >   	modified:   tools/pom.xml

        git commit -m "Set POM version to [${newversion:?}]"

    >   [20210114-zrq-working e473b9f561] Set POM version to [aglais-20210114]
    >    36 files changed, 36 insertions(+), 36 deletions(-)

        git push

    >   Enumerating objects: 150, done.
    >   Counting objects: 100% (150/150), done.
    >   Delta compression using up to 4 threads
    >   Compressing objects: 100% (76/76), done.
    >   Writing objects: 100% (78/78), 10.97 KiB | 3.66 MiB/s, done.
    >   Total 78 (delta 38), reused 0 (delta 0), pack-reused 0
    >   remote: Resolving deltas: 100% (38/38), completed with 35 local objects.
    >   To github.com:Zarquan/aglais-spark.git
    >      1288ad814e..e473b9f561  20210114-zrq-working -> 20210114-zrq-working

    popd


    source "${HOME}/aglais.env"
    pushd  "${SPARK_CODE:?}"

        newversion=aglais-spark-20210114

        for pom in $(find . -name 'pom.xml')
        do
            sed -i "
                s/<version project='aglais-spark'>[^<]*<\/version>/<version project='aglais-spark'>${newversion:?}<\/version>/
                " "${pom:?}"
        done

        git add .
        git status

    >   On branch 20210114-zrq-working
    >   Your branch is up to date with 'origin/20210114-zrq-working'.
    >   
    >   Changes to be committed:
    >     (use "git restore --staged <file>..." to unstage)
    >   	modified:   assembly/pom.xml
    >   	modified:   common/kvstore/pom.xml
    >   	modified:   common/network-common/pom.xml
    >   	modified:   common/network-shuffle/pom.xml
    >   	modified:   common/network-yarn/pom.xml
    >   	modified:   common/sketch/pom.xml
    >   	modified:   common/tags/pom.xml
    >   	modified:   common/unsafe/pom.xml
    >   	modified:   core/pom.xml
    >   	modified:   examples/pom.xml
    >   	modified:   external/avro/pom.xml
    >   	modified:   external/docker-integration-tests/pom.xml
    >   	modified:   external/kafka-0-10-assembly/pom.xml
    >   	modified:   external/kafka-0-10-sql/pom.xml
    >   	modified:   external/kafka-0-10-token-provider/pom.xml
    >   	modified:   external/kafka-0-10/pom.xml
    >   	modified:   external/kinesis-asl-assembly/pom.xml
    >   	modified:   external/kinesis-asl/pom.xml
    >   	modified:   external/spark-ganglia-lgpl/pom.xml
    >   	modified:   graphx/pom.xml
    >   	modified:   hadoop-cloud/pom.xml
    >   	modified:   launcher/pom.xml
    >   	modified:   mllib-local/pom.xml
    >   	modified:   mllib/pom.xml
    >   	modified:   pom.xml
    >   	modified:   repl/pom.xml
    >   	modified:   resource-managers/kubernetes/core/pom.xml
    >   	modified:   resource-managers/kubernetes/integration-tests/pom.xml
    >   	modified:   resource-managers/mesos/pom.xml
    >   	modified:   resource-managers/yarn/pom.xml
    >   	modified:   sql/catalyst/pom.xml
    >   	modified:   sql/core/pom.xml
    >   	modified:   sql/hive-thriftserver/pom.xml
    >   	modified:   sql/hive/pom.xml
    >   	modified:   streaming/pom.xml
    >   	modified:   tools/pom.xml


        git commit -m "Set POM version to [${newversion:?}]"

    >   [20210114-zrq-working e05b0683b3] Set POM version to [aglais-spark-20210114]
    >    36 files changed, 36 insertions(+), 36 deletions(-)


        git push

    >   Enumerating objects: 150, done.
    >   Counting objects: 100% (150/150), done.
    >   Delta compression using up to 4 threads
    >   Compressing objects: 100% (76/76), done.
    >   Writing objects: 100% (78/78), 10.09 KiB | 2.52 MiB/s, done.
    >   Total 78 (delta 38), reused 0 (delta 0), pack-reused 0
    >   remote: Resolving deltas: 100% (38/38), completed with 35 local objects.
    >   To github.com:Zarquan/aglais-spark.git
    >      e473b9f561..e05b0683b3  20210114-zrq-working -> 20210114-zrq-working

    popd


